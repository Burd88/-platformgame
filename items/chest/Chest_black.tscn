[gd_scene load_steps=16 format=2]

[ext_resource path="res://items/chest/S_ItemHeavyOutline_ChestPurple_00.png" type="Texture" id=1]
[ext_resource path="res://items/chest/Image12.png" type="Texture" id=2]
[ext_resource path="res://items/chest/Panel.gd" type="Script" id=3]
[ext_resource path="res://items/chest/ItemList.gd" type="Script" id=4]
[ext_resource path="res://resourse/inventory_panel.png" type="Texture" id=5]
[ext_resource path="res://icon1.png" type="Texture" id=6]
[ext_resource path="res://resourse/button_Style_tex.tres" type="StyleBox" id=7]
[ext_resource path="res://fonts/main_menu_button.tres" type="DynamicFont" id=8]

[sub_resource type="GDScript" id=1]
script/source = "extends Area2D

# Declare member variables here. Examples:
# var a = 2
# var b = \"text\"
var useable = true
var target
var no_use = false
export var item_ids ={0:0,1:0,2:0,3:0}
export var item_amount = {0:0,1:0,2:0,3:0}
onready var blue = load(\"res://items/chest/S_ItemHeavyOutline_ChestBlue_00.png\")
onready var gold = load(\"res://items/chest/S_ItemHeavyOutline_ChestGold_00.png\")
onready var green = load(\"res://items/chest/S_ItemHeavyOutline_ChestGreen_00.png\")
onready var purple = load(\"res://items/chest/S_ItemHeavyOutline_ChestPurple_00.png\")
onready var red = load(\"res://items/chest/S_ItemHeavyOutline_ChestRed_00.png\")
var texture_array = [\"res://items/chest/S_ItemHeavyOutline_ChestBlue_00.png\"
,\"res://items/chest/S_ItemHeavyOutline_ChestGold_00.png\"
,\"res://items/chest/S_ItemHeavyOutline_ChestGreen_00.png\"
,\"res://items/chest/S_ItemHeavyOutline_ChestPurple_00.png\"
,\"res://items/chest/S_ItemHeavyOutline_ChestRed_00.png\"]
# Called when the node enters the scene tree for the first time.
var inventory_save
func _ready():
	$Sprite.texture = load(texture_array[randi()%5])
	pass # Replace with function body.

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta):
	if target:
		if global_position.distance_to(target.global_position) > 50:
			$CanvasLayer/Panel.hide()
	
	pass




func _on_Chest_black_area_entered(area):
	if area.name == \"use\":
		$CanvasLayer/Panel.show()
		
		if no_use == false:
			$CanvasLayer/Panel/ItemList.add_item_chest(item_ids,item_amount)
			no_use = true
			inventory_save = $CanvasLayer/Panel/ItemList.inventory
		elif no_use == true:
			$CanvasLayer/Panel/ItemList.load_item_chest(inventory_save)
		target = area
		
	pass # Replace with function body.

func save(): # сохранение игры

	var save_dict = {
		\"filename\" : get_filename(),
		\"parent\" : get_parent().get_path(),
		\"pos_x\" : position.x, # Vector2 is not supported by JSON
		\"pos_y\" : position.y,
		\"name\" : name,
		\"item_ids\" : item_ids,
		\"no_use\" : no_use,
		\"inventory_save\" : inventory_save,
		\"item_amount\" : item_amount
		
	
	}

	return save_dict

	pass


#func _on_ItemList_item_selected(index):
#	var id_item = $CanvasLayer/Panel/ItemList.get_item_metadata(index)[\"id\"]
#
#	if get_parent().get_node(\"Player/inventary/inventory/bag1\"):
#		get_parent().get_node(\"Player/inventary/inventory/bag1\").update_slot(Global_Player.inventory_addItem(int(id_item)))
#		$CanvasLayer/Panel/ItemList.remove_item(index)
#	pass # Replace with function body.


func _on_ItemMenu_Button_DropItem_pressed():
	var newAmount = inventory_removeItem($CanvasLayer/Panel/ItemList.dropItemSlot)
	
	var player = get_tree().get_nodes_in_group(\"player\")
	if (newAmount < 1):
		$CanvasLayer/Panel/WindowDialog_ItemMenu.hide()
	else:
		$CanvasLayer/Panel/WindowDialog_ItemMenu/ItemMenu_Button_DropItem.set_text(\"(\" + String(newAmount) + \") \" +tr(\"COLLECT_BUTTON\"))
	

	if player[0].get_node(\"inventary/inventory/bag1\"):
		player[0].get_node(\"inventary/inventory/bag1\").update_slot(Global_Player.inventory_addItem(int($CanvasLayer/Panel/ItemList.get_item_metadata($CanvasLayer/Panel/ItemList.dropItemSlot)[\"id\"])))
	$CanvasLayer/Panel/ItemList.update_slot($CanvasLayer/Panel/ItemList.dropItemSlot)
	pass # Replace with function body.
	
func inventory_removeItem(slot) -> int:
	var newAmount = $CanvasLayer/Panel/ItemList.inventory[String(slot)][\"amount\"] - 1
	if (newAmount < 1):
		inventory_updateItem(slot, 0, 0)

		return 0
	$CanvasLayer/Panel/ItemList.inventory[String(slot)][\"amount\"] = newAmount
	return newAmount

func inventory_updateItem(slot:int, new_id:int, new_amount:int) -> void:
	if (slot < 0):
		return
	if (new_amount < 0):
		return
	if (Global_ItemDatabase.get_item(str(new_id)).empty()):
		return
	$CanvasLayer/Panel/ItemList.inventory[str(slot)] = {\"id\": str(new_id), \"amount\": int(new_amount)}"

[sub_resource type="RectangleShape2D" id=2]
extents = Vector2( 10, 6.04535 )

[sub_resource type="StyleBoxTexture" id=3]
texture = ExtResource( 2 )
region_rect = Rect2( 0, 0, 220, 220 )

[sub_resource type="StyleBoxEmpty" id=4]

[sub_resource type="Gradient" id=5]
offsets = PoolRealArray( 0, 0.895161, 1 )
colors = PoolColorArray( 0.968627, 0.184314, 0.184314, 1, 0.992916, 0.815813, 0.815813, 1, 1, 1, 1, 1 )

[sub_resource type="GradientTexture" id=6]
gradient = SubResource( 5 )

[sub_resource type="StyleBoxTexture" id=7]
texture = ExtResource( 5 )
region_rect = Rect2( 0, 0, 400, 120 )

[node name="Chest" type="Area2D" groups=[
"save",
]]
script = SubResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = SubResource( 2 )

[node name="Sprite" type="Sprite" parent="."]
texture = ExtResource( 1 )

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="Panel" type="Panel" parent="CanvasLayer"]
visible = false
margin_left = 499.87
margin_top = 7.0
margin_right = 719.87
margin_bottom = 227.0
custom_styles/panel = SubResource( 3 )
script = ExtResource( 3 )

[node name="ItemList" type="ItemList" parent="CanvasLayer/Panel"]
margin_left = 68.0
margin_top = 77.0
margin_right = 154.0
margin_bottom = 164.0
custom_styles/bg = SubResource( 4 )
custom_constants/icon_margin = -20
script = ExtResource( 4 )

[node name="WindowDialog_ItemMenu" type="WindowDialog" parent="CanvasLayer/Panel"]
margin_left = 427.0
margin_top = 108.0
margin_right = 757.0
margin_bottom = 438.0
custom_icons/close_highlight = SubResource( 6 )
custom_styles/panel = SubResource( 7 )

[node name="ItemMenu_TextureFrame_Icon" type="TextureRect" parent="CanvasLayer/Panel/WindowDialog_ItemMenu"]
margin_left = 125.784
margin_top = 38.1606
margin_right = 189.784
margin_bottom = 102.161
texture = ExtResource( 6 )
stretch_mode = 1

[node name="ItemMenu_RichTextLabel_ItemInfo" type="RichTextLabel" parent="CanvasLayer/Panel/WindowDialog_ItemMenu"]
margin_left = 31.0
margin_top = 111.0
margin_right = 297.0
margin_bottom = 237.0
bbcode_enabled = true

[node name="ItemMenu_Button_DropItem" type="Button" parent="CanvasLayer/Panel/WindowDialog_ItemMenu"]
margin_left = 110.119
margin_top = 246.729
margin_right = 220.119
margin_bottom = 281.729
custom_styles/hover = ExtResource( 7 )
custom_styles/pressed = ExtResource( 7 )
custom_styles/focus = ExtResource( 7 )
custom_styles/disabled = ExtResource( 7 )
custom_styles/normal = ExtResource( 7 )
custom_fonts/font = ExtResource( 8 )
text = "Кнопка"
[connection signal="area_entered" from="." to="." method="_on_Chest_black_area_entered"]
[connection signal="item_rmb_selected" from="CanvasLayer/Panel/ItemList" to="CanvasLayer/Panel" method="_on_ItemList_item_rmb_selected"]
[connection signal="pressed" from="CanvasLayer/Panel/WindowDialog_ItemMenu/ItemMenu_Button_DropItem" to="." method="_on_ItemMenu_Button_DropItem_pressed"]
